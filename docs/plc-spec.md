# PLC Integration Spec (Local)

This document is the handoff spec for PLC engineers.

## 1) Protocol

- Protocol: Modbus TCP
- Port: `502` (use `1502` if privileged port is blocked)
- Unit ID: `1`
- Data type: 16-bit unsigned integer (Holding Registers)
- Endianness: standard Modbus word order

## 2) Addressing

Each bay uses a 10-register block.

- `bay1`: 40001 ~ 40010 (offset 0 ~ 9)
- `bay2`: 40011 ~ 40020 (offset 10 ~ 19)
- `bay3`: 40021 ~ 40030 (offset 20 ~ 29)

## 3) Register Map (Holding Registers)

| Offset | Address | Name | Access | Values |
| --- | --- | --- | --- | --- |
| 0 | 40001 | COMMAND | Write | 0: NONE, 1: START, 2: STOP |
| 1 | 40002 | COURSE | Write | 1: BASIC, 2: STANDARD, 3: PREMIUM, 4: DELUXE |
| 2 | 40003 | STATUS | Read | 0: IDLE, 1: WASHING, 2: COMPLETED, 3: CANCELED, 4: ERROR |
| 3 | 40004 | PROGRESS | Read | 0 ~ 100 |
| 4 | 40005 | ERROR | Read | 0: NONE (reserved) |

## 4) Command Semantics

- COMMAND is edge-triggered.
- On START:
  - PLC should read COURSE and begin a new wash cycle.
  - PLC should update STATUS to WASHING and PROGRESS to 0.
- On STOP:
  - PLC should stop immediately and set STATUS to CANCELED.
- After consuming a command, PLC should reset COMMAND to 0 (NONE).

## 5) Status Semantics

- STATUS represents the PLC internal state.
- COMPLETED indicates the wash is finished. Gateway maps it to `DONE`.
- ERROR indicates a device fault. Gateway maps it to `ERROR`.
- OFFLINE is not a PLC status; it is generated by Gateway when Modbus is unreachable.

Gateway state mapping:
- IDLE -> `IDLE`
- WASHING -> `WASHING`
- COMPLETED -> `DONE`
- CANCELED -> `CANCELED`
- ERROR -> `ERROR`

## 6) Timing

- Gateway polls PLC every 1s (configurable).
- Recommended PLC update rate: <= 1s for PROGRESS.

## 7) Error Codes

PLC ERROR register is currently reserved.
- 0: NONE

Gateway errorCode values:
- `PLC_OFFLINE` when Modbus link is down.

## 8) Session/Request IDs

- Session/Request IDs are generated in Gateway/Backend (not in PLC).
- PLC does not need to manage IDs.

## 9) Test Checklist

- START/STOP works for each bay.
- PROGRESS goes 0 -> 100 during WASHING.
- COMPLETED transitions to IDLE after finish.
- Modbus disconnect -> OFFLINE is emitted by Gateway.

## 10) Related Docs

- Message contract: `docs/message-contract.md`
- Modbus register map: `docs/modbus-register-map.md`
